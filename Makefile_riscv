PREFIX=~/riscv-linux32/bin/riscv32-unknown-linux-gnu-
ARGS = -fno-rtti -fno-exceptions -march=rv32im -mabi=ilp32 -O3 -g -ffunction-sections
# ARGS = -fno-rtti -fno-exceptions -march=rv64imac -mabi=lp64  -O3 -g

ARGS += -I ../shared68k -DMACHINE_MODE

.SECONDARY:

all: uartloader.bin uartloader.mem

clean:
	rm -f *.bin *.o *.elf *.a

%.bin: %.elf
	$(PREFIX)objcopy -O binary $^ $@

%.o: %.cpp $(HEADERS) Makefile_riscv
	$(PREFIX)c++ $< -c -o $@ -g -std=c++14 -Wall $(ARGS)

%.o: %.S
	$(PREFIX)c++ $< -c -o $@ -g

../shared68k/shared.a:
	$(MAKE) -C ../shared68k -f Makefile_riscv

uartloader.elf: main.o ../shared68k/shared.a
	$(PREFIX)c++ $^ -o $@ -g -static -nostartfiles -L../shared68k -l:shared.a -Wl,-Tscript_rom.lds -Wl,--gc-sections
	$(PREFIX)size $@

uartloader.bin: uartloader.elf
	$(PREFIX)objcopy $^ -O binary $@

uartloader.mem: uartloader.bin
	hexdump -v -f format $^ > $@
